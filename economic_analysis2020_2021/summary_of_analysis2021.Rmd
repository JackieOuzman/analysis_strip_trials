---
title: "Soil testing outputs"
author: "Jackie Ouzman"
date: "11/02/2021"
output: html_document
---

```{r setup and load library, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(scales)
```

## Summary of trials 

CSIRO team have been supplied with spatial data for the location of strip trials.
Along with this information we have details on the type of trial and the fertilisers used.


At the date of this report the below graphs reflect the trials for the 2020 - 2021 season.

Note that for a few paddocks we have both N and P trials.



```{r load_data, echo=FALSE, message=FALSE, warning=FALSE}
fert_app_select_clm <- read.csv("W:/value_soil_testing_prj/Yield_data/analysis_strip_trials_April/economic_analysis2020_2021/fert_app_select_clm.csv")

spatial_data_no_yld <- read_csv("W:/value_soil_testing_prj/Yield_data/analysis_strip_trials_April/all_strips_centroid_2021-02-11.csv")


# note that this file was generated from spatial analysis and R code
# the R code / script is:

#"W:\value_soil_testing_prj\Yield_data\analysis_strip_trials_April\economic_analysis2020_2021\spatial_data_no_yld.R"
#"W:\value_soil_testing_prj\Yield_data\analysis_strip_trials_April\economic_analysis2020_2021\work_out_N_P_content_no_starter_TD.R"



# number_paddocks <- distinct(spatial_data_no_yld, Paddock_ID , .keep_all = TRUE) %>% 
#   dplyr::select(Paddock_ID, Strip_Type, Alt_GSP, av_rain) 
  
plot1 <- distinct(spatial_data_no_yld, Paddock_ID , .keep_all = TRUE) %>% 
  dplyr::select(Paddock_ID, Strip_Type, Alt_GSP, av_rain) %>%  
  ggplot( aes(Strip_Type)) +
  geom_bar() +
  theme_bw()+
  geom_text(aes(y = ((..count..)), label = ((..count..))), stat = "count", vjust = -0.25) +
  labs(title = "Number of P and N trials 2020 to 2021 season", y = "Count", x = "Type of trial")
plot1



```

In each paddocks fertiliser strips were implented by the growers.

The fertiliser rate of these strips we intented to be reflect how fertilser practices would change as a results of a soil test.

Each paddock had soil test taken for N and P per zone (often 2 zones per paddock).

Need to add more details here....

Using the soil test results a recommended fertiliser rate could be derived.

However this recommend rate did not tranlate to a fertilise strip rate.

Instead the strip rates were often decised in collabration between the grower and consulntant.

What the project ended up with was a number of strips that were differnt to the growers standrad prcatice.

A common scenario was; 

- 1/2 the growers rate 
- double the growers rate 
- strip that reflected the growers rate.

In the frist season of data collection, we identified the growers standard practice and compared the fertiliser strips to this.

We did this is each zone that the soil samples were taken.


The below graph is the number of strips per paddock.

Note that the grouping called Alt GPS contains 2 strips that reflect the growers standard practice.

while the no alt GPS only conatins one strip that reflect the growers standrad practice.

(more details on Alt to follow).

Note:

For some paddocks / growers variable fertilsier rate is common prcatice.
In these paddocks it is difficult to reflect the growers standard practice, as it changes through the paddock.

The below graph summaries the number of different rates per paddock.
The most common is 3 different rates (for the alt GSP this is listed as 4 strips beacuse we have an alterative GPS)

Also note that we have a paddock that has 9 rates.
This is one of Micheal Moodies paddocks and reflects both the VR and the trial desigin.
These paddocks may be excluded from the final analysis.



```{r plot3 number of strips, echo=FALSE, message=FALSE, warning=FALSE}

plot3 <- distinct(spatial_data_no_yld, ID_trial_type , .keep_all = TRUE) %>% 
  dplyr::select(Paddock_ID, StripCount,  Strip_Type, Alt_GSP, av_rain) %>%  
  ggplot( aes(as.factor(StripCount))) +
  geom_bar() +
  facet_grid(Strip_Type~Alt_GSP)+
  theme_bw()+
  geom_text(aes(y = ((..count..)), label = ((..count..))), stat = "count", vjust = -0.25) +
  labs(title = "Total number of strips per paddocks. 2020 to 2021 season", 
       y = "Count", 
       x = "Number of strips",
       subtitle = paste0("Total number of paddocks = ", count(distinct(spatial_data_no_yld, ID_trial_type ))))
plot3

```


The results in the frist season were suprising.

Higher rates of fertiliser did not always equate to higher yeilds.

This may occur for many reasons:

- poor location of the strips.
- mismatch between the strips and the yield mointor data.
- small sample size e.g. the number of yield points per strip and zone.
- large variation in the soil type.
- edge effect of the strips


In order to better understand the yeild varition of the paddocks, we identified an extra strip to reflect the growers standard practice.

This analysis will be undertaken at a later date, but we will quatify the yield variablity betwen the GSP and the Alt GSP.

In some paddocks we cannot identify an additional strip to reflect the Alt GSP.
The below graphs reflect the numbers.

```{r plot2 alt strips, echo=FALSE, message=FALSE, warning=FALSE}
plot2 <- distinct(spatial_data_no_yld, ID_trial_type , .keep_all = TRUE) %>% 
  dplyr::select(Paddock_ID, Strip_Type, Alt_GSP, av_rain) %>%  
  ggplot( aes(Alt_GSP)) +
  geom_bar() +
  theme_bw()+
  geom_text(aes(y = ((..count..)), label = ((..count..))), stat = "count", vjust = -0.25) +
  labs(title = "Number of paddocks with Alt GSP 2020 to 2021 season", 
       y = "Count", 
       x = "Alternative GSP identified",
       subtitle = paste0("Total number of paddocks = ", count(distinct(spatial_data_no_yld, ID_trial_type ))))
plot2

```


The cost of fertiliser is reflected by the rainfall zone.

We have used the location of the trials to derive and average rainfall.

See code - for more details

The rainfall is assigned to rainfall class

low rainfall            <= 350 mm
medium rainfall between 350 to 500 mm
high rainfall > 500 mm



```{r plot4 rainfall, echo=FALSE, message=FALSE, warning=FALSE}


spatial_data_no_yld <- spatial_data_no_yld %>% 
dplyr::mutate(
  rainfall_class = case_when(
    av_rain<=350 ~ "low",
    av_rain >500 ~ "high",
    TRUE ~ "medium"
  )
)

spatial_data_no_yld$rainfall_class <- as.factor(spatial_data_no_yld$rainfall_class)
spatial_data_no_yld$rainfall_class <- factor(spatial_data_no_yld$rainfall_class, 
                                             levels = c("high", "medium", "low"))

plot4 <- distinct(spatial_data_no_yld, ID_trial_type , .keep_all = TRUE) %>% 
  dplyr::select(Paddock_ID, StripCount,  Strip_Type, Alt_GSP, av_rain, rainfall_class) %>%  
  ggplot( aes(rainfall_class)) +
  geom_bar() +
  facet_grid(.~ Strip_Type)+
  theme_bw()+
  geom_text(aes(y = ((..count..)), label = ((..count..))), stat = "count", vjust = -0.25) +
  labs(title = "Total number of strips per rainfall class 2020 to 2021 season", 
       y = "Count", 
       x = "rainfall class")
       #subtitle = paste0("Total number of paddocks = ", count(distinct(spatial_data_no_yld, ID_trial_type )))
       
plot4
```

The fertiliser that was applied in each strip was confirmed with a pre harvest map.

The product and rates applied are converted to N or P content
The below code is a check of what products have been applied in a N and P trial


```{r fert_applied, echo=FALSE, message=FALSE, warning=FALSE}




fert_app_all_steps <- read.csv("W:/value_soil_testing_prj/Yield_data/analysis_strip_trials_April/economic_analysis2020_2021/fert_app_all_steps.csv")

#str(fert_app_all_steps)

## what is are the products applied N?
N_products <- fert_app_all_steps %>% 
  filter(Strip_Type == "N Strip")
N_products <- N_products %>% 
  dplyr::select(Paddock_ID,
  product_fert1, 
  product_fert2, 
  product_fert3,
  Total_sum_N_content,
  GSP,
  av_rain)
N_products_narrow <- pivot_longer(N_products,
                                 cols = c(product_fert1,
                                 product_fert2,
                                 product_fert3),
                                 names_to = "product_order",
                                 values_to = "product")
N_products_narrow <- N_products_narrow %>% 
  dplyr::distinct(product, .keep_all = TRUE)

print(N_products_narrow$product)

## what is are the products applied P?
P_products <- fert_app_all_steps %>% 
  filter(Strip_Type == "P Strip")
P_products <- P_products %>% 
  dplyr::select(Paddock_ID,
                product_fert1, 
                product_fert2, 
                product_fert3,
                Total_sum_N_content,
                GSP,
                av_rain)
P_products_narrow <- pivot_longer(P_products,
                                  cols = c(product_fert1,
                                           product_fert2,
                                           product_fert3),
                                  names_to = "product_order",
                                  values_to = "product")
P_products_narrow <- P_products_narrow %>% 
  dplyr::distinct(product, .keep_all = TRUE)

print(P_products_narrow$product)
```


ahh


### how much N or P was applied?
```{r fert_applied in N, echo=FALSE, message=FALSE, warning=FALSE}
str(fert_app_all_steps)

N_applied <- fert_app_all_steps %>% 
  filter(Strip_Type == "N Strip")  %>% 
   filter((GSP !="Alt GSP")%>% 
                  replace_na(TRUE)) %>% 
  dplyr::select(ID_Rate_GSP_type,
                Paddock_ID,
                Total_sum_N_content,
                GSP,
                av_rain)

str(N_applied)
N_applied <- N_applied %>% 
  dplyr::mutate(
    rainfall_class = case_when(
      av_rain<=350 ~ "low",
      av_rain >500 ~ "high",
      TRUE ~ "medium"
    )
  )

N_applied$rainfall_class <- as.factor(N_applied$rainfall_class)
N_applied$rainfall_class <- factor(N_applied$rainfall_class, 
                                             levels = c("high", "medium", "low"))


N_applied_summary <- N_applied %>% 
  group_by(rainfall_class) %>% 
  summarise(max_N_applied = max(Total_sum_N_content),
            mim_N_applied = min(Total_sum_N_content))

print(N_applied_summary)
```



## Summary of spatial data

This data is a summary of what paddocks implemented a N or P fertiliser trial.
For these paddocks, we were given spatial data that allowed us to create maps.
These pre harvest map contain:

- loaction of strips in paddock
- location of zone (zones are location that the soil sampling was done)
- legends which indicate how much fertiliser was applied (product and rate)



```{r pressure, echo=FALSE}
str(spatial_data_no_yld)

spatial_data_no_yld_ID_only <- spatial_data_no_yld %>% 
  distinct(Paddock_ID, .keep_all = TRUE) %>% 
  dplyr::select(Paddock_ID, Strip_Type, StripCount, Alt_GSP,av_rain )
  
  spatial_data_no_yld %>% 
  group_by(Paddock_ID, Strip_Type)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
